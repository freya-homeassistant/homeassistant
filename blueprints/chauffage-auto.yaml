blueprint:
  name: Chauffage – Automatisation (Confort selon heure calculée)
  description: >
    Pilote un Versatile Thermostat en fonction d'un calendrier de présence/absence et
    d'une heure de démarrage calculée (input_datetime) : passage en preset Confort à
    l'heure prévue, et maintien/retour en preset Éco en dehors de la fenêtre ou en absence.
  domain: automation
  input:
    thermostat:
      name: Thermostat Versatile
      selector:
        entity:
          domain: climate

    calendrier_presence:
      name: Calendrier Présence
      selector:
        entity:
          domain: calendar

    calendrier_absence:
      name: Calendrier Absence
      selector:
        entity:
          domain: calendar

    preset_confort:
      name: Preset Confort
      default: comfort
      selector:
        select:
          options:
            - label: "Eco"
              value: eco
            - label: "Comfort"
              value: comfort
            - label: "Eco"
              value: eco

    preset_eco:
      name: Preset Éco
      default: eco
      selector:
        select:
          options:
            - label: "Eco"
              value: eco
            - label: "Comfort"
              value: comfort
            - label: "Eco"
              value: eco

    heure_prochaine_chauffe:
      name: Calendrier prochaine chauffe
      description: Calendrier de l'heure calculée de la prochaine chauffe.
      selector:
        entity:
          domain: input_datetime

    watchdog_interval_minutes:
      name: Intervalle de vérification (minutes)
      description: Fréquence de re-vérification du preset (sécurité). 1 = toutes les minutes.
      default: 5
      selector:
        number:
          min: 1
          max: 60
          step: 1
          mode: box

mode: single

variables:
  thermostat_entity: !input thermostat
  calendrier_presence_entity: !input calendrier_presence
  calendrier_absence_entity: !input calendrier_absence
  heure_prochaine_chauffe_entity: !input heure_prochaine_chauffe
  preset_confort_value: !input preset_confort
  preset_eco_value: !input preset_eco
  watchdog_interval_minutes_value: !input watchdog_interval_minutes

trigger:
  - platform: homeassistant
    event: start

  - platform: template
    value_template: >
      {{ now().second == 0 and (now().minute % watchdog_interval_minutes_value) == 0 }}

  - platform: template
    value_template: >
      {% set start_raw = states(heure_prochaine_chauffe_entity) %}
      {% set ts_start = start_raw not in ['unknown', 'unavailable', 'none', ''] and as_local(today_at(start_raw)) or none %}
      {% set end_raw = state_attr(calendrier_presence_entity, 'end_time') %}
      {% set ts_end = end_raw and as_local(as_datetime(end_raw)) or none %}
      {{ is_state(calendrier_presence_entity, 'on') and ts_start and ts_end and now() >= ts_start and now() < ts_end }}

  - platform: template
    value_template: >
      {% set end_raw = state_attr(calendrier_presence_entity, 'end_time') %}
      {% set ts_end = end_raw and as_local(as_datetime(end_raw)) or none %}
      {{ is_state(calendrier_presence_entity, 'on') and ts_end and now() >= ts_end }}

  - platform: state
    entity_id: !input calendrier_presence

  - platform: state
    entity_id: !input calendrier_presence
    from: "on"
    to: "off"

  - platform: state
    entity_id: !input heure_prochaine_chauffe

  - platform: state
    entity_id: !input calendrier_absence

condition:
  - condition: state
    entity_id: !input calendrier_absence
    state: "off"

action:
  - variables:
      comfort_window: >
        {% set start_raw = states(heure_prochaine_chauffe_entity) %}
        {% set ts_start = start_raw not in ['unknown', 'unavailable', 'none', ''] and as_local(today_at(start_raw)) or none %}
        {% set end_raw = state_attr(calendrier_presence_entity, 'end_time') %}
        {% set ts_end = end_raw and as_local(as_datetime(end_raw)) or none %}
        {{ is_state(calendrier_presence_entity, 'on') and ts_start and ts_end and now() >= ts_start and now() < ts_end }}
      desired_preset: >
        {{ preset_confort_value if comfort_window else preset_eco_value }}
      preset_mode_current: >
        {{ state_attr(thermostat_entity, 'preset_mode') }}

  - choose:
      - conditions:
          - condition: template
            value_template: >
              {{ is_state(calendrier_presence_entity, 'off') and preset_mode_current != preset_eco_value }}
        sequence:
          - service: climate.set_preset_mode
            target:
              entity_id: !input thermostat
            data:
              preset_mode: "{{ preset_eco_value }}"

      - conditions:
          - condition: template
            value_template: >
              {{ is_state(calendrier_presence_entity, 'on') and preset_mode_current != preset_confort_value }}
        sequence:
          - service: climate.set_preset_mode
            target:
              entity_id: !input thermostat
            data:
              preset_mode: "{{ preset_confort_value }}"

      - conditions:
          - condition: template
            value_template: >
              {{ comfort_window and preset_mode_current != desired_preset }}
        sequence:
          - service: climate.set_preset_mode
            target:
              entity_id: !input thermostat
            data:
              preset_mode: "{{ preset_confort_value }}"
    default:
      - condition: template
        value_template: "{{ not comfort_window and preset_mode_current != desired_preset }}"
      - service: climate.set_preset_mode
        target:
          entity_id: !input thermostat
        data:
          preset_mode: "{{ preset_eco_value }}"
